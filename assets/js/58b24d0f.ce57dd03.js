"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2116],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=i.createContext({}),l=function(e){var t=i.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=l(e.components);return i.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},p=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=l(n),m=a,f=p["".concat(c,".").concat(m)]||p[m]||u[m]||o;return n?i.createElement(f,r(r({ref:t},d),{},{components:n})):i.createElement(f,r({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=p;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var l=2;l<o;l++)r[l]=n[l];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8424:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return c},default:function(){return m},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return u}});var i=n(3117),a=n(102),o=(n(7294),n(3905)),r=["components"],s={title:"Notifications and automated flows"},c="Notification API and how to structure email flows",l={unversionedId:"how-to/notification-api",id:"how-to/notification-api",title:"Notifications and automated flows",description:"Introduction",source:"@site/../../docs/content/how-to/notification-api.md",sourceDirName:"how-to",slug:"/how-to/notification-api",permalink:"/how-to/notification-api",editUrl:"https://github.com/medusajs/medusa/edit/master/www/../../docs/content/how-to/notification-api.md",tags:[],version:"current",frontMatter:{title:"Notifications and automated flows"},sidebar:"tutorialSidebar",previous:{title:"Frontend Payment Flow in Checkout",permalink:"/advanced/backend/payment/frontend-payment-flow-in-checkout"},next:{title:"Plugins",permalink:"/guides/plugins"}},d={},u=[{value:"Introduction",id:"introduction",level:3},{value:"How it works",id:"how-it-works",level:3},{value:"Creating automated notification flows",id:"creating-automated-notification-flows",level:2}],p={toc:u};function m(e){var t=e.components,n=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"notification-api-and-how-to-structure-email-flows"},"Notification API and how to structure email flows"),(0,o.kt)("h3",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"Plugins offer a way to extend and integrate the core functionality of Adminfirstly. For a walkthrough of the implementation details behind these, please see ",(0,o.kt)("a",{parentName:"p",href:"https://docs.adminfirstly.com/guides/plugins"},"Plugins in Adminfirstly"),"."),(0,o.kt)("p",null,"Adminfirstly makes it possible for plugins to implement the Notification API. The API allows for different types of implementations of notifications (emails, text messages, Slack messages, etc), that are sent as a reaction to events in Adminfirstly. All Notifications are stored in the database with information about the receiver of the notification and what plugin was in charge of sending it. This allows merchants to resend notifications, but also gives an overview of what communication has been sent to customers."),(0,o.kt)("h3",{id:"how-it-works"},"How it works"),(0,o.kt)("p",null,"The Notification API works by subscribing to all events that are emitted to the Event Bus and channeling them through to notification plugins that listen to the events. In a plugin you can subscribe to a notification event by exporting a subscriber class that calls ",(0,o.kt)("inlineCode",{parentName:"p"},"notificationService.subscribe"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'// src/subscribers/my-notification.js\n\nclass MyNotification {\n  constructor({ notificationService }) {\n    // Subscribe to order.placed events\n    notificationService.subscribe("order.placed", "my-service");\n  }\n}\n\nexport default MyNotification;\n')),(0,o.kt)("p",null,"The above code tells the notification service to send ",(0,o.kt)("inlineCode",{parentName:"p"},"order.placed")," events to the ",(0,o.kt)("inlineCode",{parentName:"p"},"my-service")," notification service implemented in your plugin."),(0,o.kt)("p",null,"For a plugin to work with the Notification API you must implement 2 methods ",(0,o.kt)("inlineCode",{parentName:"p"},"sendNotification")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"resendNotification"),";"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'// src/services/my-notification.js\n\nclass MyService extends NotificationService {\n  static identifier = "my-service";\n\n  constructor({ orderService }, options) {\n    super();\n\n    this.options_ = options;\n    this.orderService_ = orderService;\n  }\n\n  async sendNotification(eventName, eventData, attachmentGenerator) {\n    let sendData;\n    switch (eventName) {\n      case "order.placed":\n        sendData = await this.orderService_.retrieve(eventData.id);\n        break;\n      default:\n        // If the return value is undefined no notification will be stored\n        return;\n    }\n\n    await CoolEmailSender.send({\n      email: sendData.email,\n      templateData: sendData,\n    });\n\n    return { to: sendData.email, data: sendData };\n  }\n\n  async resendNotification(notification, config, attachmentGenerator) {\n    const recipient = config.to || notification.to;\n\n    await CoolEmailSender.send({\n      email: recipient,\n      templateData: notification.data,\n    });\n\n    return { to: sendOptions.to, data: notification.data };\n  }\n}\n\nexport default MyService;\n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"}," A notification service must have a static property called ",(0,o.kt)("inlineCode",{parentName:"p"},"identifier")," this is used to determine which classes are called when subscribing to different events. In this case the service identifier is ",(0,o.kt)("inlineCode",{parentName:"p"},"my-service")," so to subscribe to notifications you must use:\n",(0,o.kt)("inlineCode",{parentName:"p"},'notificationService.subscribe([eventname], "my-service")')))),(0,o.kt)("p",null,"The above class is an example implementation of a NotificationService. It uses a fictional email service called ",(0,o.kt)("inlineCode",{parentName:"p"},"CoolEmailSender")," to send emails to a customer whenever an order is placed. The ",(0,o.kt)("inlineCode",{parentName:"p"},"sendNotification")," implementation gets the event name and fetches relevant data based on what event is being processed; in this case it retrieves an order, which is later used when requesting ",(0,o.kt)("inlineCode",{parentName:"p"},"CoolEmailSender")," to dispatch an email. The address to send the email to is likewise fetched from the order."),(0,o.kt)("p",null,"The return type of ",(0,o.kt)("inlineCode",{parentName:"p"},"sendNotification")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"resendNotification")," is an object with ",(0,o.kt)("inlineCode",{parentName:"p"},"to")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"data"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"to")," prop should identify the receiver of the notification, in this case an email, but it could also be a phone number, an ID, a channel name or something similar depending on the type of notification provider. The ",(0,o.kt)("inlineCode",{parentName:"p"},"data")," prop contains the data as it was gathered when the notification was sent; the same data will be provided if the notification is resent at a later point."),(0,o.kt)("p",null,"When ",(0,o.kt)("inlineCode",{parentName:"p"},"resendNotification")," is called the original Notification is provided along with a config object. The config object may contain a ",(0,o.kt)("inlineCode",{parentName:"p"},"to")," property that can be used to overwrite the original ",(0,o.kt)("inlineCode",{parentName:"p"},"to"),"."),(0,o.kt)("h2",{id:"creating-automated-notification-flows"},"Creating automated notification flows"),(0,o.kt)("p",null,"When running an ecommerce store you typically want to send communication to your customers when different events occur, these include messages like order confirmations and shipping updates. With Adminfirstly you can create transactional notifications as a reaction to a wide spectrum of events, allowing you to automate communication and processes. An example of a flow that can be implemented using Adminfirstly's Notification API is automated return flows. Below is an outline of how an automated return flow might work."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Customer requests a return with ",(0,o.kt)("inlineCode",{parentName:"li"},"POST /store/returns")),(0,o.kt)("li",{parentName:"ul"},"Notification Service listens for ",(0,o.kt)("inlineCode",{parentName:"li"},"order.return_requested")," and sends email to the customer with a return invoice and return label generated by fulfillment provider"),(0,o.kt)("li",{parentName:"ul"},"Customer returns items triggering ",(0,o.kt)("inlineCode",{parentName:"li"},"return.recieved")),(0,o.kt)("li",{parentName:"ul"},"Notification Service listens for ",(0,o.kt)("inlineCode",{parentName:"li"},"return.received")," and sends email to the customer with confirmation that their items have been received and that a refund has been issued.")),(0,o.kt)("p",null,"Check out ",(0,o.kt)("inlineCode",{parentName:"p"},"adminfirstly-plugin-sendgrid")," for an Notification API implementation that works with Sendgrid."))}m.isMDXComponent=!0}}]);