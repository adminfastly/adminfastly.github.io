"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9450],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),d=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=d(a),m=i,u=h["".concat(l,".").concat(m)]||h[m]||c[m]||r;return a?n.createElement(u,o(o({ref:t},p),{},{components:a})):n.createElement(u,o({ref:t},p))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var d=2;d<r;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},4870:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return c}});var n=a(3117),i=a(102),r=(a(7294),a(3905)),o=["components"],s={},l="Architecture Overview",d={unversionedId:"advanced/backend/payment/overview",id:"advanced/backend/payment/overview",title:"Architecture Overview",description:"In this document, you\u2019ll learn about the payment architecture in Adminfirstly, specifically its 3 main components and the idempotency key.",source:"@site/../../docs/content/advanced/backend/payment/overview.md",sourceDirName:"advanced/backend/payment",slug:"/advanced/backend/payment/overview",permalink:"/advanced/backend/payment/overview",editUrl:"https://github.com/medusajs/medusa/edit/master/www/../../docs/content/advanced/backend/payment/overview.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to Add a Fulfillment Provider",permalink:"/advanced/backend/shipping/add-fulfillment-provider"},next:{title:"How to Create a Payment Provider",permalink:"/advanced/backend/payment/how-to-create-payment-provider"}},p={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Payment Provider",id:"payment-provider",level:2},{value:"Overview",id:"overview",level:3},{value:"How it is Created",id:"how-it-is-created",level:3},{value:"Model Overview",id:"model-overview",level:3},{value:"Payment Session",id:"payment-session",level:2},{value:"Overview",id:"overview-1",level:3},{value:"How it is Created",id:"how-it-is-created-1",level:3},{value:"Model Overview",id:"model-overview-1",level:3},{value:"Payment",id:"payment",level:2},{value:"Overview",id:"overview-2",level:3},{value:"How it is Created",id:"how-it-is-created-2",level:3},{value:"Model Overview",id:"model-overview-2",level:3},{value:"Idempotency Key",id:"idempotency-key",level:2}],h={toc:c};function m(e){var t=e.components,a=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"architecture-overview"},"Architecture Overview"),(0,r.kt)("p",null,"In this document, you\u2019ll learn about the payment architecture in Adminfirstly, specifically its 3 main components and the idempotency key."),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"The payment architecture refers to all operations in an ecommerce store related to processing a customer\u2019s payment. It includes the checkout flow and order handling including refunds and swaps."),(0,r.kt)("p",null,"In Adminfirstly, there are 3 main components in the payment architecture: Payment Provider, Payment Session, and Payment."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("strong",{parentName:"li"},"Payment Provider")," is a service or method used to capture, authorize, and refund payments, among other functionalities."),(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("strong",{parentName:"li"},"Payment Session")," is a session associated with a cart and created during a customer\u2019s checkout flow. It is controlled by the ",(0,r.kt)("strong",{parentName:"li"},"Payment Provider")," to authorize the payment and is used eventually to create a ",(0,r.kt)("strong",{parentName:"li"},"Payment"),"."),(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("strong",{parentName:"li"},"Payment")," is associated with an order and it represents the amount authorized for the purchase. It is used later for further payment operations such as capturing or refunding payments.")),(0,r.kt)("p",null,"An important part in the Payment architecture to understand is the ",(0,r.kt)("strong",{parentName:"p"},"Idempotency Key"),". It\u2019s a unique value that\u2019s generated for a cart and is used to retry payments during checkout if they fail."),(0,r.kt)("h2",{id:"payment-provider"},"Payment Provider"),(0,r.kt)("h3",{id:"overview"},"Overview"),(0,r.kt)("p",null,"A Payment Provider in Adminfirstly is a method to handle payments in selected regions. It is not associated with a cart, customer, or order in particular. It provides the necessary implementation to create Payment Sessions and Payments, as well as authorize and capture payments, among other functionalities."),(0,r.kt)("p",null,"Payment Providers can be integrated with third-party services that handle payment operations such as capturing a payment. An example of a Payment Provider is Stripe."),(0,r.kt)("p",null,"Payment Providers can also be related to a custom way of handling payment operations. An example of that is cash on delivery (COD) payment methods or Adminfirstly\u2019s ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/adminfirstly/adminfirstly/tree/master/packages/adminfirstly-payment-manual"},"manual payment provider plugin")," which provides a minimal implementation of a payment provider and allows store operators to manually handle order payments."),(0,r.kt)("h3",{id:"how-it-is-created"},"How it is Created"),(0,r.kt)("p",null,"A Payment Provider is essentially a Adminfirstly ",(0,r.kt)("a",{parentName:"p",href:"/advanced/backend/services/create-service"},"service")," with a unique identifier, and it extends the ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentService")," provided by the ",(0,r.kt)("inlineCode",{parentName:"p"},"adminfirstly-interfaces")," package. It can be created as part of a ",(0,r.kt)("a",{parentName:"p",href:"/guides/plugins"},"plugin"),", or it can be created just as a service file in your Adminfirstly server."),(0,r.kt)("p",null,"As a developer, you will mainly work with the Payment Provider when integrating a payment method in Adminfirstly."),(0,r.kt)("p",null,"When you run your Adminfirstly server, the Payment Provider will be registered on your server if it hasn\u2019t been already."),(0,r.kt)("p",null,"Once the Payment Provider is added to the server, the store operator will be able to choose on the ",(0,r.kt)("a",{parentName:"p",href:"/admin/quickstart"},"Adminfirstly Admin")," the payment providers available in a region. These payment providers are shown to the customer at checkout to choose from and use."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"It\u2019s important to choose a payment provider in the list of payment providers in a region, or else the payment provider cannot be used by customers on checkout."))),(0,r.kt)("h3",{id:"model-overview"},"Model Overview"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentProvider")," model only has 2 attributes: ",(0,r.kt)("inlineCode",{parentName:"p"},"is_installed")," to indicate if the payment provider is installed and its value is a boolean; and ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," which is the unique identifier that you define in the Payment Provider service."),(0,r.kt)("h2",{id:"payment-session"},"Payment Session"),(0,r.kt)("h3",{id:"overview-1"},"Overview"),(0,r.kt)("p",null,"Payment Sessions are linked to a customer\u2019s cart. Each Payment Session is associated with a payment provider that is available in the customer cart\u2019s region."),(0,r.kt)("p",null,"They hold the status of the payment flow throughout the checkout process which can be used to indicate different statuses such as an authorized payment or payment that requires more actions from the customer."),(0,r.kt)("p",null,"After the checkout process is completed and the Payment Session has been authorized successfully, a Payment instance will be created to be associated with the customer\u2019s order and will be used for further actions related to that order."),(0,r.kt)("h3",{id:"how-it-is-created-1"},"How it is Created"),(0,r.kt)("p",null,"After the customer adds products to the cart, proceeds with the checkout flow, and reaches the payment method section, Payment Sessions are created for each Payment Provider available in that region. "),(0,r.kt)("p",null,"During the creation of the Payment Session, the Payment Provider can interact with third-party services for any initialization necessary on their side. For example, when a Payment Session for Stripe is being created, a payment intent associated with the customer can be created with Stripe as well."),(0,r.kt)("p",null,"Payment Sessions can hold data that is necessary for the customer to complete their payment."),(0,r.kt)("p",null,"Among the Payment Sessions available only one will be selected based on the customer\u2019s payment provider choice. For example, if the customer sees that they can pay with Stripe or PayPal and chooses Stripe, Stripe\u2019s Payment Session will be the selected Payment Session of that cart."),(0,r.kt)("h3",{id:"model-overview-1"},"Model Overview"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentSession")," model belongs to a ",(0,r.kt)("inlineCode",{parentName:"p"},"Cart"),". This is the customer\u2018s cart that was used for checkout which lead to the creation of the Payment Session."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentSession")," also belongs to a ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentProvider"),". This is the Payment Provider that was used to create the Payment Session and that controls it for further actions like authorizing the payment."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," attribute is an object that holds any data required for the Payment Provider to perform payment operations like authorizing or capturing payment. For example, when a Stripe payment session is initialized, the ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object will hold the payment intent among other data necessary to authorize the payment."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"is_selected")," attribute in the ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentSession")," model is a boolean value that indicates whether this Payment Session was selected by the customer to pay for their purchase. Going back to the previous example of having Stripe and PayPal as the available Payment Providers, when the customer chooses Stripe, Stripe\u2019s Payment Session will have ",(0,r.kt)("inlineCode",{parentName:"p"},"is_selected")," set to true whereas PayPal\u2019s Payment Session will have ",(0,r.kt)("inlineCode",{parentName:"p"},"is_selected")," set to false."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"status")," attributes indicates the current status of the Payment Session. It can be one of the following values:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"authorized"),": The payment has been authorized which means the order can be placed successfully."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"pending"),": The payment is still pending further actions. This is usually used when the payment session is initialized."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"requires_more"),": The payment requires additional actions from the customer before the payment can be authorized successfully and the order can be placed. An example of this is payment methods that require 3-D Secure checks."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"error"),": An error was encountered when an authorization was attempted. This status is usually used when an error has been encountered when authorizing the payment with a third-party payment provider."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"canceled"),": The payment has been canceled.")),(0,r.kt)("p",null,"These statuses are important in the checkout flow to determine the current step the customer is at and which action should come next. For example, if there is an attempt to place the order but the status of the Payment Session is not ",(0,r.kt)("inlineCode",{parentName:"p"},"authorized"),", an error will be thrown."),(0,r.kt)("h2",{id:"payment"},"Payment"),(0,r.kt)("h3",{id:"overview-2"},"Overview"),(0,r.kt)("p",null,"A Payment is used to represent the amount authorized for a customer\u2019s purchase. It is associated with the order placed by the customer and will be used after that for all operations related to the order\u2019s payment such as capturing or refunding the payment."),(0,r.kt)("p",null,"Payments are generally created using data from the Payment Session and it holds any data that can be necessary to perform later payment operations."),(0,r.kt)("h3",{id:"how-it-is-created-2"},"How it is Created"),(0,r.kt)("p",null,"Once the customer completes their purchase and the payment has been authorized, a Payment instance will be created from the Payment Session. The Payment is associated first with the cart and then with the order once it\u2019s created and placed."),(0,r.kt)("p",null,"When the store operator then chooses to capture the order from the Adminfirstly Admin, the Payment is used by the Payment Provider to capture the payment. This is the same case for refunding the amount, canceling the order, or creating a swap."),(0,r.kt)("h3",{id:"model-overview-2"},"Model Overview"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Payment")," model belongs to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Cart")," that it was originally created from when the customer\u2019s payment was authorized. It also belongs to an ",(0,r.kt)("inlineCode",{parentName:"p"},"Order")," once it\u2019s placed. Additionally, it belongs to a ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentProvider")," which is the payment provider that the customer chose on checkout."),(0,r.kt)("p",null,"In case a ",(0,r.kt)("inlineCode",{parentName:"p"},"Swap")," is created for an order, ",(0,r.kt)("inlineCode",{parentName:"p"},"Payment")," will be associated with that swap to handle payment operations related to it."),(0,r.kt)("p",null,"Similar to ",(0,r.kt)("inlineCode",{parentName:"p"},"PaymentSession"),",  ",(0,r.kt)("inlineCode",{parentName:"p"},"Payment")," has a ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," attribute which is an object that holds any data required to perform further actions with the payment such as capturing the payment."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Payment")," also holds attributes like ",(0,r.kt)("inlineCode",{parentName:"p"},"amount")," which is the amount authorized for payment, and ",(0,r.kt)("inlineCode",{parentName:"p"},"amount_refunded")," which is the amount refunded from the original amount if a refund has been initiated."),(0,r.kt)("p",null,"Additionally, ",(0,r.kt)("inlineCode",{parentName:"p"},"Payment")," has the ",(0,r.kt)("inlineCode",{parentName:"p"},"captured_at")," date-time attribute which is filled when the payment has been captured, and a ",(0,r.kt)("inlineCode",{parentName:"p"},"canceled_at")," date-time attribute which is filled when the order has been canceled."),(0,r.kt)("h2",{id:"idempotency-key"},"Idempotency Key"),(0,r.kt)("p",null,"An Idempotency Key is a unique key associated with a cart. It is generated at the last step of checkout before authorization of the payment is attempted."),(0,r.kt)("p",null,"That Idempotency Key is then set in the header under the ",(0,r.kt)("inlineCode",{parentName:"p"},"Idempotency-Key")," response header field along with the header field ",(0,r.kt)("inlineCode",{parentName:"p"},"Access-Control-Expose-Headers")," set to ",(0,r.kt)("inlineCode",{parentName:"p"},"Idempotency-Key"),"."),(0,r.kt)("p",null,"If an error occurs or the purchase is interrupted at any step, the client can retry the payment by adding the Idempotency Key of the cart as the ",(0,r.kt)("inlineCode",{parentName:"p"},"Idempotency-Key")," header field in their subsequent requests. "),(0,r.kt)("p",null,"The server wraps each essential part of the checkout completion in its own step and stores the current step of checkout with its associated Idempotency Key. "),(0,r.kt)("p",null,"If then the request is interrupted for any reason or the payment fails, the client can retry completing the check out using the Idempotency Key, and the flow will continue from the last stored step."),(0,r.kt)("p",null,"This prevents any payment issues from occurring with the customers and allows for secure retries of failed payments or interrupted connections."))}m.isMDXComponent=!0}}]);