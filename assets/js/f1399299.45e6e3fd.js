"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7344],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=i,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||r;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9162:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return p}});var a=n(3117),i=n(102),r=(n(7294),n(3905)),o=["components"],s={title:"Adding custom functionality"},l="Adding custom functionality",c={unversionedId:"tutorial/adding-custom-functionality",id:"tutorial/adding-custom-functionality",title:"Adding custom functionality",description:"Introduction",source:"@site/../../docs/content/tutorial/2-adding-custom-functionality.md",sourceDirName:"tutorial",slug:"/tutorial/adding-custom-functionality",permalink:"/tutorial/adding-custom-functionality",editUrl:"https://github.com/medusajs/medusa/edit/master/www/../../docs/content/tutorial/2-adding-custom-functionality.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Adding custom functionality"}},d={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Services",id:"services",level:2},{value:"<code>constructor</code>",id:"constructor",level:3},{value:"<code>registerOptin</code>",id:"registeroptin",level:3},{value:"<code>sendWelcome</code>",id:"sendwelcome",level:3},{value:"Endpoints",id:"endpoints",level:2},{value:"Controller implementation",id:"controller-implementation",level:3},{value:"Subscribers",id:"subscribers",level:2},{value:"Summary",id:"summary",level:2},{value:"What&#39;s next?",id:"whats-next",level:3}],u={toc:p};function m(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"adding-custom-functionality"},"Adding custom functionality"),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"In the previous part of the tutorial we set up your Adminfirstly project using the ",(0,r.kt)("inlineCode",{parentName:"p"},"adminfirstly new")," and started your Adminfirstly server locally. In this part we will start adding some custom functionality that extends the core. In particular this tutorial will take you through adding custom services, custom endpoints and subscribers. The custom functionality that we will be adding will create an endpoint called ",(0,r.kt)("inlineCode",{parentName:"p"},"/welcome/:cart_id")," which customers of your store can use to opt-in to receiving a welcome in their email inbox after completing their order."),(0,r.kt)("p",null,"The custom functionality will do a number of things:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a custom service that handles the logic around opting in. The service will ensure that only first time buyers will receive a welcome."),(0,r.kt)("li",{parentName:"ul"},"Create a custom endpoint at ",(0,r.kt)("inlineCode",{parentName:"li"},"/welcome/:cart_id")," which will take a ",(0,r.kt)("inlineCode",{parentName:"li"},"optin")," parameter as part of its request body, and call our custom service."),(0,r.kt)("li",{parentName:"ul"},"Create a subscriber that listens for the ",(0,r.kt)("inlineCode",{parentName:"li"},"order.placed")," event and tells the custom service to send a welcome.")),(0,r.kt)("h2",{id:"services"},"Services"),(0,r.kt)("p",null,"We will begin our custom implementation by adding a custom service. In your project create a new file at ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/services/welcome.js"),". Open the newly created file and add a class:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import { BaseService } from "adminfirstly-interfaces"\n\nclass WelcomeService extends BaseService {\n  constructor({}) {\n    super()\n  }\n\n  async registerOptin(cartId, optin) {}\n\n  async sendWelcome(orderId) {}\n}\n\nexport default WelcomeService\n')),(0,r.kt)("p",null,"We will be filling out each of the methods in turn, but before we get to that it should be noted that placing files in ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/services")," has a special meaning in Adminfirstly projects. When Adminfirstly starts up it will look for files in this folder and register exports from these files to the global container. The global container holds all services and repositories in your Adminfirstly project allowing for dependency injection. Dependency injection is a software development technique in which objects only receive other objects that it depends upon."),(0,r.kt)("h3",{id:"constructor"},(0,r.kt)("inlineCode",{parentName:"h3"},"constructor")),(0,r.kt)("p",null,"We will see dependency injection in action now when implementing the constructor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"constructor({ cartService, orderService }) {\n  super()\n\n  this.cartService_ = cartService\n\n  this.orderService_ = orderService\n}\n")),(0,r.kt)("p",null,"In the constructor we specify that our ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService")," will depend upon the ",(0,r.kt)("inlineCode",{parentName:"p"},"cartService")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"orderService")," and Adminfirstly will make sure to provide those as the first argument to the constructor when starting up Adminfirstly. We then keep a reference to these services within the ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService")," so that we can use them later on."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Just like we can depend on the ",(0,r.kt)("inlineCode",{parentName:"p"},"cartService")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"orderService")," other services will be able to depend on our newly created ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService"),". The registration name of our service is the camelCased version of our file name with the registration type appended. I.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/services/welcome.js")," -> ",(0,r.kt)("inlineCode",{parentName:"p"},"welcomeService"),"."))),(0,r.kt)("h3",{id:"registeroptin"},(0,r.kt)("inlineCode",{parentName:"h3"},"registerOptin")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"registerOption")," function will take two arguments: ",(0,r.kt)("inlineCode",{parentName:"p"},"cartId")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"optin"),", where ",(0,r.kt)("inlineCode",{parentName:"p"},"cartId")," holds the id of the cart that we wish to register optin for and ",(0,r.kt)("inlineCode",{parentName:"p"},"optin")," is a boolean to indicate if the customer has accepted or optin or not. We will save the ",(0,r.kt)("inlineCode",{parentName:"p"},"optin")," preferences in the cart's ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata")," field, so that it can be persisted for the future when we need to evaluate if we should send the welcome or not."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'async registerOptin(cartId, optin) {\n  if (typeof optin !== "boolean") {\n    throw new Error("optin must be a boolean value.")\n  }\n\n  return await this.cartService_.update(cartId, {\n    metadata: { welcome_optin: optin }\n  })\n}\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"registerOptin")," implementation simply validates that the provided argument is of the correct type and calls the CartService function ",(0,r.kt)("inlineCode",{parentName:"p"},"update"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"update")," takes two arguments: the first is the id of the cart to update and the second is an object that with the key/value pairs that we want to update. In this case we are updating the metadata on the cart. The ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata")," field on the cart is itself an object so we need to pass an object when updating this field."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Most entities in Adminfirstly have a ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata")," field that can be used for customizations or integrations when it is necessary to persist some data relating to the entity. Metadata cannot be overridden by other\nplugins."))),(0,r.kt)("h3",{id:"sendwelcome"},(0,r.kt)("inlineCode",{parentName:"h3"},"sendWelcome")),(0,r.kt)("p",null,"The final function to implement in our class is the ",(0,r.kt)("inlineCode",{parentName:"p"},"sendWelcome")," function that takes one argument ",(0,r.kt)("inlineCode",{parentName:"p"},"orderId")," which holds the id of an order that we will evaluate whether to send a welcome for. In the implementation we leverage that when an order is created from a cart all the cart's metadata is copied to the order. We can therefore check ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata.welcome_optin")," to evaluate if the customer has allowed us to send a welcome to their email."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'async sendWelcome(orderId) {\n  const order = await this.orderService_.retrieve(orderId, {\n    select: ["email", "customer_id", "metadata"]\n  })\n\n  const prevOrders = await this.orderService_.list({\n    customer_id: order.customer_id\n  }, {\n    select: ["id"]\n  })\n\n  if (prevOrders.length > 1) {\n    // We only send welcomes to new customers. This customer\n    // has already completed an order before so we can stop.\n    return\n  }\n\n  if (order.metadata && order.metadata.welcome_optin) {\n    // Customer opted in so we should send an email\n    return await someEmailSender.send({\n      to: order.email,\n      subject: "Welcome to our Adminfirstly Store!",\n      body: `We are so happy to have you!`\n    })\n  }\n}\n')),(0,r.kt)("p",null,"In the above implementation we are first retrieving the order that we need to check if we should send a welcome for. We are selecting only the fields that we need. In this case the ",(0,r.kt)("inlineCode",{parentName:"p"},"email")," on the order, we will use this if we need to send out the welcome email, the ",(0,r.kt)("inlineCode",{parentName:"p"},"customer_id")," which is used to determine if the customer has completed prior orders and ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata")," to check if the customer opted in to receiving the welcome email."),(0,r.kt)("p",null,"After retrieving the order we list all orders that have the same ",(0,r.kt)("inlineCode",{parentName:"p"},"customer_id")," as the order we just retrieved. We are only interested in the count of these orders so it is sufficient for us to just select the ids of these orders."),(0,r.kt)("p",null,"We then check if the number of previous orders is greater than 1, indicating that the customer has previously purchased anything from our store. If the number of previous orders is greater than 1 we can exit our function prematurely as we only send welcomes to new customers."),(0,r.kt)("p",null,"The final part of the implementation checks if the ",(0,r.kt)("inlineCode",{parentName:"p"},"welcome_optin")," metadata has been set to true. If the customer has opted in we use ",(0,r.kt)("inlineCode",{parentName:"p"},"someEmailService.send")," to trigger and email dispatch to the email stored on the order. In this case ",(0,r.kt)("inlineCode",{parentName:"p"},"someEmailSender")," could be any email service for example Sendgrid, SES, Mailgun, etc."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If you have ",(0,r.kt)("inlineCode",{parentName:"p"},"adminfirstly-plugin-sendgrid")," installed you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"sendgridService")," in your constructor to use it later in ",(0,r.kt)("inlineCode",{parentName:"p"},"sendWelcome"),". You will then be able to do ",(0,r.kt)("inlineCode",{parentName:"p"},"sendgridService.send({ ... })"),"."))),(0,r.kt)("p",null,"We have completed the implementation of our custom service and we will now be able to call it from elsewhere in our project."),(0,r.kt)("h2",{id:"endpoints"},"Endpoints"),(0,r.kt)("p",null,"Similarly to the ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/services")," directory, the ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/api")," directory has a special meaning in Adminfirstly. Exports from this directory are assumed to be functions that return an express router instance that will be registered on the internal express app that Adminfirstly creates when starting your server. This allows you to create custom endpoints for custom functionality. We will use this to create the custom endpoint that customers can use to give there welcome opt-in."),(0,r.kt)("p",null,"Create a new file at ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/api/index.js")," and add the following controller:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import { Router } from "express"\nimport bodyParser from "body-parser"\n\nexport default () => {\n  const app = Router()\n\n  app.post("/welcome/:cart_id", bodyParser.json(), async (req, res) => {\n    // TODO\n  })\n\n  return app\n}\n')),(0,r.kt)("h3",{id:"controller-implementation"},"Controller implementation"),(0,r.kt)("p",null,"Our endpoint controller's implementation will be very simple. It will extract the ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," from the path paramater and the ",(0,r.kt)("inlineCode",{parentName:"p"},"optin")," flag from the request body. We will then use these values to call our the ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService"),", which will take care of updating the cart metadata for later."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'app.post("/welcome/:cart_id", bodyParser.json(), async (req, res) => {\n  const { cart_id } = req.params\n  const { optin } = req.body\n\n  // Validate that the optin value was provided.\n  // If not respond with a Bad Request status\n  if (typeof optin !== "boolean") {\n    res.status(400).json({\n      message: "You must provide an boolean optin value in the request body",\n    })\n    return\n  }\n\n  const welcomeService = req.scope.resolve("welcomeService")\n\n  try {\n    await welcomeService.registerOptin(cart_id, optin)\n\n    res.status(200).json({\n      success: true,\n    })\n  } catch (err) {\n    // This is not supposed to happen.\n    res.status(500).json({\n      message: "Something unexpected happened.",\n    })\n  }\n})\n')),(0,r.kt)("p",null,"In the implementation above we are first validating that the request body is structured correctly so that we can proceed with our opt-in registration. If the validation fails we respond with 400 Bad Request which is an HTTP code that indicates that the client that sent the request has not provided the correct values."),(0,r.kt)("p",null,"After validation is passed we leverage Adminfirstly's container system again to fetch our custom service. When Adminfirstly starts up it places an object on the express ",(0,r.kt)("inlineCode",{parentName:"p"},"req")," object called ",(0,r.kt)("inlineCode",{parentName:"p"},"scope")," which contains the function ",(0,r.kt)("inlineCode",{parentName:"p"},"resolve")," that can be used to get any of the services registered in Adminfirstly by simply providing the registration name as a string. In this case we are resolving our custom ",(0,r.kt)("inlineCode",{parentName:"p"},"welcomeService"),", but you can resolve any service such as the ",(0,r.kt)("inlineCode",{parentName:"p"},"cartService")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"orderService")," using this function."),(0,r.kt)("p",null,"We put our ",(0,r.kt)("inlineCode",{parentName:"p"},"registerOptin")," function call in a try-catch block to ensure that we can handle unexpected errors. If the call to ",(0,r.kt)("inlineCode",{parentName:"p"},"registerOptin")," succeeds we respond with 200 OK and if for some reason we encounter an error we respond with 500 Internal Server Error."),(0,r.kt)("p",null,"We have now completed the implementation necessary to complete opt-in registration on a cart. To test that your implementation is working correctly start up your Adminfirstly server using: ",(0,r.kt)("inlineCode",{parentName:"p"},"adminfirstly develop"),". You can now send requests to the server, first create a new cart using:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl -X POST localhost:9000/store/carts | python -m json.tool\n")),(0,r.kt)("p",null,"The copy the cart id (the one that starts with ",(0,r.kt)("inlineCode",{parentName:"p"},"cart_"),") and use it to opt-in to the welcome pack using:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl -X POST \\\n     -H 'Content-Type: application/json' \\\n     -d '{ \"optin\": true }' \\\n     localhost:9000/welcome/[copied cart id]\n")),(0,r.kt)("p",null,"The endpoint should respond with ",(0,r.kt)("inlineCode",{parentName:"p"},'{"success":true}'),". If you wish to check that the ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata")," field has been updated you can fetch the created cart by doing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl -X GET localhost:9000/store/carts/[copied cart id] | python -m json.tool\n")),(0,r.kt)("p",null,"The response should contain the cart with the metadata field set like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n  "cart": {\n    ...,\n    "metadata": {\n      "welcome_optin": true\n    },\n    ...\n  }\n}\n')),(0,r.kt)("h2",{id:"subscribers"},"Subscribers"),(0,r.kt)("p",null,"The final thing that we will add in this part of the tutorial is the subscriber that listens for the ",(0,r.kt)("inlineCode",{parentName:"p"},"order.placed")," event and sends out emails if the user has opted in for welcomes. Again we will leverage one of the special directories in Adminfirstly that makes dependency injection easy and automatic. The directory to place a file in this time is the ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/subscribers")," directory, which treats exports as subscribers and makes sure the inject dependencies in a similar fashion to what we saw with services. To get started with our implementation create a file at ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/subscribers/welcome.js")," and add the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'class WelcomeSubscriber {\n  constructor({ welcomeService, eventBusService }) {\n    this.welcomeService_ = welcomeService\n\n    eventBusService.subscribe("order.placed", this.handleWelcome)\n  }\n\n  handleWelcome = async (data) => {\n    return await this.welcomeService_.sendWelcome(data.id)\n  }\n}\n\nexport default WelcomeSubscriber\n')),(0,r.kt)("p",null,"The implementation above is all that is needed to automate the ",(0,r.kt)("inlineCode",{parentName:"p"},"sendWelcome")," function to be called every time a new order is created. The subscriber class here delegates all of the business logic to the ",(0,r.kt)("inlineCode",{parentName:"p"},"sendWelcome")," function, where we are checking for opt-in and first time buyers."),(0,r.kt)("p",null,"If we take a closer look at the constructor it will seem pretty familiar. Just like with our custom service, we are indicating which dependencies we would like to receive and Adminfirstly will make sure to pass these on as the first argument to our constructor. In this case we are depending on the ",(0,r.kt)("inlineCode",{parentName:"p"},"welcomeService")," which is used to take care of sending welcomes, and the ",(0,r.kt)("inlineCode",{parentName:"p"},"eventBusService")," which is a core service in Adminfirstly that handles events across your server allowing you to subscribe to events of interest. In this case we are using the ",(0,r.kt)("inlineCode",{parentName:"p"},"eventBusService")," to subscribe to the ",(0,r.kt)("inlineCode",{parentName:"p"},"order.placed")," event which is emitted every time a new order is created. The subscription is registered by the ",(0,r.kt)("inlineCode",{parentName:"p"},"eventBusService.subscribe")," function which takes the event name to subscribe to as its first argument and a callback function to call when the event occurs, as its second argument."),(0,r.kt)("p",null,"In this case we are using the ",(0,r.kt)("inlineCode",{parentName:"p"},"handleWelcome")," function as our callback. The callback function receives the data that is passed for the event. The ",(0,r.kt)("inlineCode",{parentName:"p"},"order.placed")," event contains the order id in the data object which is what the ",(0,r.kt)("inlineCode",{parentName:"p"},"welcomeService")," needs to handle the sending logic so we simply call ",(0,r.kt)("inlineCode",{parentName:"p"},"sendWelcome")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"data.id"),"."),(0,r.kt)("p",null,"You can now start up your server and test out the subscriber. Given that you have opted in to receiving welcome emails you can complete an order and you should receive an email with the welcome message."),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"You have now learned how to add custom functionality to your Adminfirstly server, which is one of the most powerful features of the Adminfirstly core. The example above is quite simple, yet we have covered many of the customization capabilities available. We first looked at how to include custom business logic in Adminfirstly by using services and dependency injection. Afterwards we put that logic to use when implementing our custom endpoint and in the final part of the tutorial we added some simple automation that handles sending the welcome message on every new order."),(0,r.kt)("h3",{id:"whats-next"},"What's next?"),(0,r.kt)("p",null,"You have now been introduced to many of the key parts of Adminfirstly and with your knowledge of customization you can now begin creating some really powerful commerce experiences. If you have an idea for a cool customization go ahead and make it right now! If you are not completely ready yet you can browse the reference docs further."))}m.isMDXComponent=!0}}]);